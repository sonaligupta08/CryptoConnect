<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Messages</title>

<script
	src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script
	src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

<style>
body.dark {
	background-color: #0d0d0d;
	color: #ffffff;
	font-family: Arial, sans-serif;
}

.chat-container {
	width: 400px;
	margin: 50px auto;
	background: #1a1a1a;
	border-radius: 10px;
	padding: 15px;
}

.chat-header {
	text-align: center;
	border-bottom: 1px solid #333;
	padding-bottom: 10px;
}

#message-box {
	height: 300px;
	overflow-y: auto;
	margin: 15px 0;
}

.chat-input {
	display: flex;
}

.chat-input input {
	flex: 1;
	padding: 10px;
	background: #2a2a2a;
	border: none;
	color: white;
}

.chat-input button {
	padding: 10px 15px;
	background: #00bcd4;
	border: none;
	cursor: pointer;
}
</style>
</head>

<body class="dark">

	<div class="chat-container">
		<div class="chat-header">
			<h3>CryptoConnect Chat</h3>
		</div>

		<div id="message-box"></div>

		<div class="chat-input">
			<input type="text" id="messageInput" placeholder="Type a message..." />
			<button onclick="sendMessage()">Send</button>
		</div>
	</div>

	<script>
let stompClient = null;

const currentUser = JSON.parse(localStorage.getItem("currentUser") || "{}");
const urlParams = new URLSearchParams(window.location.search);
const receiverUser = urlParams.get("user");

if (!currentUser.username) {
	alert("Please login first");
	window.location.href = "login.html";
}

// 1️⃣ CONNECT SOCKET PROPERLY
function connectSocket() {
	const socket = new SockJS(
		"http://localhost:8080/ws?username=" + currentUser.username
	);

	stompClient = Stomp.over(socket);

	stompClient.connect({}, () => {

		console.log("Connected as", currentUser.username);

		// 2️⃣ SUBSCRIBE AFTER CONNECT
		stompClient.subscribe("/user/queue/messages", (msg) => {
			const data = JSON.parse(msg.body);

			if (
				(data.sender === receiverUser && data.receiver === currentUser.username) ||
				(data.sender === currentUser.username && data.receiver === receiverUser)
			) {
				showMessage(
					data.sender === currentUser.username ? "You" : data.sender,
					data.content,
					data.sender === currentUser.username
				);
			}
		});
	});
}

// connect socket
connectSocket();

// load chat history
async function loadChat(receiver) {
	const res = await fetch(
		`http://localhost:8080/api/chat/${currentUser.username}/${receiver}`
	);
	const messages = await res.json();

	const box = document.getElementById("message-box");
	box.innerHTML = "";

	messages.forEach(m => {
		showMessage(
			m.sender === currentUser.username ? "You" : m.sender,
			m.content,
			m.sender === currentUser.username
		);
	});
}

loadChat(receiverUser);

// send message
function sendMessage() {
	const input = document.getElementById("messageInput");
	const content = input.value.trim();
	if (!content) return;

	const message = {
		sender: currentUser.username,
		receiver: receiverUser,
		content: content
	};

	stompClient.send("/app/chat.send", {}, JSON.stringify(message));
	input.value = "";
}

// show message
function showMessage(sender, text, isSender) {
	const box = document.getElementById("message-box");

	const msg = document.createElement("div");
	msg.innerHTML = `<b>${sender}:</b> ${text}`;
	msg.style.padding = "8px";
	msg.style.margin = "5px 0";
	msg.style.borderRadius = "5px";
	msg.style.background = isSender ? "#00bcd4" : "#333";
	msg.style.color = isSender ? "#000" : "#fff";

	box.appendChild(msg);
	box.scrollTop = box.scrollHeight;
}
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">

<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
	rel="stylesheet">
<link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css"
	rel="stylesheet">

<title>Communities</title>

<style>
body {
	margin: 0;
	font-family: "Poppins", sans-serif;
	background-color: #000;
	color: #fff;
}

.outer {
	display: flex;
	height: 100vh;
}

/* Sidebar (same vibe as dashboard) */
.sidebar {
	background-color: #000;
	width: 260px;
	padding: 2rem 1.5rem;
	border-right: 1px solid #2f3336;
}

.sidebar ul {
	list-style: none;
	padding: 0;
}

.sidebar ul li {
	display: flex;
	align-items: center;
	gap: 15px;
	padding: 10px;
	font-size: 1.2rem;
	cursor: pointer;
}

.sidebar ul li:hover {
	background-color: #16181c;
	border-radius: 25px;
	color: #1d9bf0;
}

/* Main Content */
.content {
	flex-grow: 1;
	padding: 1.5rem;
	border-right: 1px solid #2f3336;
	overflow-y: auto;
}

.header {
	display: flex;
	justify-content: space-between;
	align-items: center;
	margin-bottom: 1rem;
}

.create-btn {
	background-color: #1d9bf0;
	border: none;
	color: #fff;
	padding: 8px 16px;
	border-radius: 50px;
	font-weight: 600;
}

/* Community Card */
.community-card {
	border: 1px solid #2f3336;
	border-radius: 15px;
	padding: 1rem;
	margin-bottom: 1rem;
	cursor: pointer;
	transition: 0.2s;
}

.community-card:hover {
	background-color: #16181c;
}

.community-name {
	font-size: 1.1rem;
	font-weight: 600;
}

.member-count {
	color: #777;
	font-size: 0.9rem;
}

/* Mobile bottom nav */
@media ( max-width : 768px) {
	.sidebar {
		display: none;
	}
}
</style>
</head>

<body>

	<div class="container-fluid">
		<div class="row outer">

			<!-- Sidebar -->
			<div class="sidebar d-none d-md-block">
				<ul>
					<li onclick="location.href='dashboard.html'"><i
						class='bx bx-home'></i> Home</li>
					<li class="text-primary"><i class='bx bx-group'></i>
						Communities</li>
					<li onclick="location.href='profile.html'"><i
						class='bx bx-user'></i> Profile</li>
				</ul>
			</div>

			<!-- Main Content -->
			<div class="content col-12 col-md-9">

				<div class="header">
					<h4>My Communities</h4>
					<button class="create-btn" onclick="openCreate()">+ Create</button>
				</div>

				<!-- Community List -->
				<div id="community-list">

					<!-- Example Card -->
					<div class="community-card">
						<p class="community-name">Crypto Learners</p>
						<p class="member-count">3 / 5 members</p>
					</div>

				</div>

			</div>

		</div>
	</div>

	<script>
	const currentUser = JSON.parse(localStorage.getItem("currentUser"));

	if (!currentUser) {
		alert("Please login first");
		window.location.href = "login.html";
	}

	async function loadCommunities() {
		const res = await fetch("http://localhost:8080/api/community/all");
		const communities = await res.json();

		const container = document.getElementById("community-list");
		container.innerHTML = "";

		for (let c of communities) {
			loadCommunityCard(c, container);
		}
	}
	
	async function loadCommunityCard(community, container) {
	    try {
	        const countRes = await fetch(`http://localhost:8080/api/community/member-count/${community.id}`);
	        const count = countRes.ok ? await countRes.text() : 0;

	        const memberRes = await fetch(`http://localhost:8080/api/community/is-member/${community.id}/${currentUser.id}`);
	        const isMember = memberRes.ok ? await memberRes.json() : false;

	        let buttonHTML = "";
	        if (isMember) {
	            buttonHTML = `<button class="btn btn-sm btn-outline-primary" onclick="openCommunity(${community.id})">Open</button>`;
	        } else if (count >= 5) {
	            buttonHTML = `<button class="btn btn-sm btn-secondary" disabled>Full</button>`;
	        } else {
	            buttonHTML = `<button class="btn btn-sm btn-primary" onclick="joinCommunity(${community.id})">Join</button>`;
	        }

	        const div = document.createElement("div");
	        div.className = "community-card";
	        div.innerHTML = `
	            <p class="community-name">${community.name}</p>
	            <p class="member-count">${count} / 5 members</p>
	            ${buttonHTML}
	        `;
	        container.appendChild(div);

	    } catch (err) {
	        console.error("Failed to render community:", community, err);
	    }
	}



	async function joinCommunity(communityId) {
		await fetch(
			`http://localhost:8080/api/community/add-member/${communityId}/${currentUser.id}`,
			{ method: "POST" }
		);

		loadCommunities(); 
	}
	function openCommunity(communityId) {
		window.location.href = `community.html?id=${communityId}`;
	}
	loadCommunities();
	
	
	function openCreate() {
		const name = prompt("Enter community name");

		if (!name || name.trim() === "") {
			alert("Community name cannot be empty");
			return;
		}

		fetch("http://localhost:8080/api/community/create", {
			method: "POST",
			headers: { "Content-Type": "application/json" },
			body: JSON.stringify({
				name: name.trim(),
				adminId: currentUser.id
			})
		})
		.then(res => {
			if (!res.ok) throw new Error();
			return res.json();
		})
		.then(() => {
			alert("Community created successfully!");
			loadCommunities(); 
		})
		.catch(() => alert("Failed to create community"));
	}
	



	</script>

</body>
</html>

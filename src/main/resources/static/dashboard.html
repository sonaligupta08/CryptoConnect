<!DOCTYPE html>
<html lang="en">

<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
	rel="stylesheet">
<link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css"
	rel="stylesheet">
<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script
	src="https://cdn.jsdelivr.net/npm/@joeattardi/emoji-button@3.1.1/dist/index.min.js"></script>
<script
	src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script
	src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

<title>Dashboard</title>

<style>
/* --- Styles kept as your original --- */
body {
	margin: 0;
	font-family: "Poppins", sans-serif;
	background-color: #000 !important;
	color: #fff;
}

/* Flex container for sidebar and content */
.outer {
	display: flex;
	height: 100vh;
}

/* Sidebar styles */
.sidebar {
	color: #fff !important;
	background-color: #000;
	width: 260px;
	display: flex;
	flex-direction: column;
	justify-content: space-around;
	padding: 2rem 1.5rem;
	border: 1px solid #2f3336;
	height: 100vh;
}

.brand {
	color: #fff;
	text-align: left;
	margin-bottom: 2rem;
}

.sidebar ul {
	list-style: none;
	padding: 0;
}

.sidebar ul li {
	display: flex;
	align-items: center;
	gap: 15px;
	padding: 10px 0;
	font-size: 1.2rem;
	cursor: pointer;
	transition: 0.3s;
}

.sidebar ul li:hover {
	background-color: #16181c;
	border-radius: 25px;
	padding-left: 12px;
	color: #1d9bf0;
}

.profile-section {
	display: flex;
	align-items: center;
	justify-content: space-between;
	background-color: #000;
	border-radius: 50px;
	padding: 10px;
	margin-top: 20px;
}

.profile-pic {
	background-color: #1d9bf0;
	color: #fff;
	width: 38px;
	height: 38px;
	border-radius: 50%;
	display: flex;
	align-items: center;
	justify-content: center;
	font-weight: bold;
}

.username {
	margin: 0;
	font-weight: 600;
}

.handle {
	margin: 0;
	color: #71767b;
	font-size: 0.9rem;
}

.content {
	flex-grow: 1;
	background-color: #000;
	padding: 2rem;
	border-left: 1px solid #2f3336;
	border-right: 1px solid #2f3336;
}

.coin-img {
	border-radius: 50%;
	height: 40px;
	width: 60px;
	object-fit: cover;
	box-shadow: 0 0 50px rgba(63, 121, 227, 0.9);
}

.for-you {
	border: 1px solid #2f3336;
	border-left: none;
	width: 100%;
}

.content-2 {
	flex-grow: 0.5;
	border: 1px solid #2f3336;
	background-color: #000;
}

#input {
	background-color: rgba(0, 0, 0, 0.2);
	padding: 10px;
	width: 100%;
	color: #fff;
	font-size: 1.1rem;
	outline: none;
}

.emojis {
	color: #1d9bf0;
	font-size: 20px;
}

.divide {
	border-bottom: 1px solid #2f3336;
	padding: 1 rem 0;
}

.divide .profile-section {
	display: flex;
	align-items: center;
	gap: 15px;
	background-color: transparent;
	border-radius: 0;
	padding: 0;
	margin: 0;
}

.emojis {
	display: flex;
	align-items: center;
	justify-content: space-between;
	padding: 0.5rem 0;
	color: #1d9bf0;
	font-size: 20px;
}

.post {
	background-color: #fff;
	color: #000;
	border: none;
	border-radius: 50px;
	font-weight: bold;
	font-size: 1rem;
	padding: 12px 0;
	margin-top: 10px;
	cursor: pointer;
	width: 15%;
	transition: 0.3s;
}

.search {
	padding: 12px 0;
	background-color: #000;
	color: white;
}

.connect-img img {
	margin-left: 1px;
	width: 100%;
	height: 300px;
	object-fit: cover;
	border-radius: 0;
}

#input {
	width: 100%;
	border: none;
	outline: none;
	resize: none;
	background: transparent;
	color: white;
	font-size: 1rem;
	overflow-wrap: break-word;
}

.post-card {
	padding: 1rem;
	border-bottom: 1px solid #2f3336;
	color: white;
}

.post-text {
	font-size: 1rem;
	margin-top: 10px;
	white-space: pre-wrap;
}

.action-buttons {
	display: flex;
	align-items: center;
	gap: 2rem;
	padding: 0.5rem 0;
}

.action-buttons button {
	background: transparent;
	color: white;
	border: none;
	font-size: 1.4rem;
	cursor: pointer;
	padding: 5px;
	border-radius: 50%;
	transition: 0.2s;
}

.action-buttons button:hover {
	color: #1d9bf0;
	background-color: rgba(29, 155, 240, 0.15);
}

.posted-img {
	height: 200px;
	width: 200px;
}

#image-preview img {
	width: 200px;
	height: auto;
	border-radius: 12px;
	margin-top: 10px;
	border: 1px solid #2f3336;
}
</style>
</head>

<body>
	<div class="container-fluid">
		<div class="row outer">

			<!-- Sidebar -->
			<div class="col-md-3 sidebar d-none d-md-flex flex-column">
				<h2 class="brand">
					<img src="bitcoin.png.png" alt="bitcoin" class="coin-img">
				</h2>

				<div class="menu">
					<ul>
						<li><i class='bx bx-home'></i> Home</li>
						<li><i class='bx bx-bell'></i> Notification</li>
						<li onclick="window.location.href='message.html'"><i
							class='bx bx-message'></i> Messages</li>

						<li onclick="openCommunities()"><i class='bx bx-group'></i>
							Communities</li>

						<li onclick="window.location.href='profile.html'"><i
							class='bx bx-user'></i> Profile</li>
					</ul>
				</div>

				<div class="profile-section">
					<div class="profile-pic">?</div>
					<div>
						<p class="username">Guest</p>
						<p class="handle">@guest_user</p>
					</div>
					<i class='bx bx-dots-horizontal-rounded'></i>
				</div>
			</div>

			<!-- Main Content -->
			<div class="col-12 col-md-6 content">
				<h5>For You</h5>

				<div class="divide">
					<div class="profile-section">
						<div class="profile-pic">?</div>

						<textarea placeholder="What's happening?" id="input" rows="2"></textarea>

						<input type="file" id="imageUpload" accept="image/*"
							style="display: none;">
						<div id="image-preview"></div>
					</div>

					<div class="emojis">
						<a onclick="document.getElementById('imageUpload').click()"> <i
							class="fa-regular fa-image"></i>
						</a> <a><i class='bx bx-smile'></i></a>

						<!-- Post button listener added in JS below -->
						<button class="post" type="button">Post</button>

						<button id="connectWalletBtn" class="btn btn-outline-warning mb-2">
							Connect Wallet</button>

						<p id="walletAddress" style="font-size: 12px; color: #aaa;"></p>
					</div>
				</div>

				<!-- Posts container -->
				<div id="post-feed"></div>
			</div>

			<!-- Right Side -->
			<div class="col-md-3 d-none d-md-block content-2">
				<div class="connect-img">
					<img src="connect.jpg" alt="connect">
				</div>
				<h1 class="text">Welcome To</h1>
				<h1 class="text">CryptoConnect!!</h1>
			</div>

		</div>
	</div>

	<!-- Mobile Bottom Nav -->
	<nav class="navbar navbar-dark bg-dark d-md-none fixed-bottom">
		<div class="container justify-content-around">
			<a href="#" class="text-light"><i class='bx bx-home'></i></a> <a
				href="#" class="text-light"><i class='bx bx-search'></i></a> <a
				href="#" class="text-light"><i class='bx bx-bell'></i></a> <a
				href="#" class="text-light"><i class='bx bx-user'></i></a>
		</div>
	</nav>

	<!-- SCRIPT -->
	<script>
		// Get logged-in user from localStorage
		const currentUser = JSON.parse(localStorage.getItem("currentUser") || "{}");
		
		// Wallet Connect Elements
		const walletBtn = document.getElementById("connectWalletBtn");
		const walletDisplay = document.getElementById("walletAddress");

		// Wallet connect logic
		walletBtn.addEventListener("click", async () => {
		    if (window.ethereum) {
		        try {
		            const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
		            const address = accounts[0];
		            walletDisplay.innerText = address;
		            currentUser.walletAddress = address;
		            localStorage.setItem("currentUser", JSON.stringify(currentUser));
		        } catch (err) {
		            alert("Wallet connection failed");
		            console.error(err);
		        }
		    } else {
		        alert("MetaMask not found");
		    }
		});

		// Redirect to login if user not logged in
		if (!currentUser.username) {
			alert("Please login first");
			window.location.href = "login.html";
		}

		// Update profile info
		document.querySelectorAll(".username").forEach(el => el.innerText = currentUser.username);
		document.querySelectorAll(".handle").forEach(el => el.innerText = "@" + currentUser.username);
		document.querySelectorAll(".profile-pic").forEach(el => el.innerText = currentUser.username.charAt(0).toUpperCase());

		// Function to load posts from backend
		async function loadPosts() {
			try {
				const res = await fetch(`http://localhost:8080/api/posts/all`);
				const posts = await res.json();
				
				const container = document.getElementById("post-feed");
				container.innerHTML = "";

				posts.forEach(post => {
					const div = document.createElement("div");
					div.className = "post-card";
					div.innerHTML = `
		                <div class="profile-section">
		                    <div class="profile-pic">${post.username.charAt(0).toUpperCase()}</div>
		                    <div>
		                        <p class="username">${post.username}</p>
		                        <p class="handle">@${post.username}</p>
		                    </div>
		                </div>
		                <p class="post-text">${post.content}</p>
		                ${post.imageUrl ? `<img src="${post.imageUrl}" style="width:100%; border-radius:12px;">` : ""}
						<div class="action-buttons">
							<button onclick="toggleLike(${post.id})">
								<i class='bx bx-heart' id="like-icon-${post.id}"></i>
							</button>
							<span id="like-count-${post.id}" style="cursor:pointer"></span>
					   </div>
		            `;
					container.appendChild(div);
					loadLikeStatus(post.id);
					loadLikeCount(post.id);
				});

			} catch (err) {
				console.error("Failed to load posts", err);
			}
		}

		// Like toggle function
		async function toggleLike(postId) {
			await fetch("http://localhost:8080/api/likes/toggle", {
				method: "POST",
				headers: {"Content-Type": "application/json"},
				body: JSON.stringify({
					postId: postId,
					userId: currentUser.id,
					username: currentUser.username
				})
			});
			loadLikeStatus(postId);
			loadLikeCount(postId);
		}

		// Load like count
		async function loadLikeCount(postId) {
			const res = await fetch(`http://localhost:8080/api/likes/count/${postId}`);
			const count = await res.text();
			document.getElementById(`like-count-${postId}`).innerText = count + " Likes";
		}

		// Load like status (red heart or empty)
		async function loadLikeStatus(postId) {
			const res = await fetch(
				`http://localhost:8080/api/likes/status/${postId}/${currentUser.id}`
			);
			const liked = await res.json();
			const icon = document.getElementById(`like-icon-${postId}`);
			icon.className = liked ? "bx bxs-heart" : "bx bx-heart";
			icon.style.color = liked ? "#ff4d4d" : "white";
		}

		// Post new content listener
		document.querySelector(".post").addEventListener("click", async () => {
			const content = document.getElementById("input").value.trim();
			if (!content) return alert("Write something to post!");

			// Generate post hash
			const postHash = btoa((currentUser.walletAddress || "guest") + "_" + content + "_" + new Date().getTime());

			try {
				await fetch("http://localhost:8080/api/posts/create", {
					method: "POST",
					headers: { "Content-Type": "application/json" },
					body: JSON.stringify({
						userId: currentUser.id,
						content: content,
						postHash: postHash,
						walletAddress: currentUser.walletAddress,
						imageUrl: selectedImage || null
					})
				});

				document.getElementById("input").value = "";
				document.getElementById("image-preview").innerHTML = "";
				selectedImage = null;

				// Reload posts
				loadPosts();

			} catch (err) {
				console.error("Failed to post", err);
				alert("Failed to post content");
			}
		});

		// Image preview logic
		const imageInput = document.getElementById("imageUpload");
		let selectedImage = null;

		imageInput.addEventListener("change", () => {
			const file = imageInput.files[0];
			if (!file) return;

			const reader = new FileReader();
			reader.onload = e => {
				selectedImage = e.target.result;
				document.getElementById("image-preview").innerHTML = `<img src="${selectedImage}">`;
			};
			reader.readAsDataURL(file);
		});

		// Initial load of posts
		loadPosts();
		
		// Open communities page
		function openCommunities() {
			window.location.href = "communities.html";
		}

		// WebSocket/STOMP setup
		let stompClient = null;
		function connectSocket() {
		    const socket = new SockJS("http://localhost:8080/ws");
		    stompClient = Stomp.over(socket);
		    stompClient.connect({}, () => {
		    	// Subscribe to notifications
		    	stompClient.subscribe("/topic/notifications", (msg) => {
		    	    const data = JSON.parse(msg.body);
		    	    console.log("Notification:", data);
		    	    alert(`Notification: ${data.content}`);
		    	});
		    });
		}

		connectSocket();
	</script>

</body>
</html>